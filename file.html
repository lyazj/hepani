<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Upload</title>
  </head>
  <body>
    <h1>Upload a file</h1>
    <p>To generate animation, we need a file in which one or more hign energy physics events are stored.</p>
    <p>By now, two types of file are supported:</p>
    <ul>
      <li>
        running log from <em>pythia8</em> (
        <strong>plain text format</strong>, usually <strong>.txt</strong> or <strong>.log</strong>
        )
      </li>
      <li>
        HepMC2, storing HEP event(s) generated by <em>pythia8</em> (
        usually <strong>.hepmc</strong>
        )
      </li>
    </ul>
    <p>To go back home, <a href="javascript:shouldRequestJSON=false;writePage('/')">click here</a>.</p>
    <p>
    What you see in index page is a VBS process generated by <em>pythia8</em>.
    While running <em>pythia8</em>,
    we redirected <tt>stdout</tt> (<em>pythia8</em> uses it to output running logs) to a writable path,
    thus a valid input for animation is generated.
    All events are stored in a HepMC2 file after <em>pythia8</em> exits normally, (if so, )
    which is also a valid input to be uploaded.
    </p>
    <p>Let's have a try!</p>

    <form id="upload" action="/" method="post" enctype="multipart/form-data">
      <fieldset>
        <legend>Upload a file</legend>
        Select a type:
        <select name="type" id="type">
          <option value="py8log">running log from pythia8</option>
          <option value="hepmc2">HepMC2 file type</option>
        </select>
        <br />
        Select a file:
        <input type="file" name="input" id="input" />
        <br />
        Check twice and click:
        <!--
          <input type="submit" value="upload" />
        -->
        <button onclick="return submitUpload()">upload</button>
        <br />
      </fieldset>
    </form>

    <p>Note: if no file selected, an example of selected type will be used.</p>
    <p>
    For more information about <em>pythia8</em>, see: <a href="https://pythia.org/" target="_black">PYTHIA official site</a>.
    For help, see: <a href="coming.html" target="_black">help page</a>.
    </p>

    <script src="load.js"></script>
    <script>
      loadJS("https://cdn.bootcdn.net/ajax/libs/pako/2.0.3/pako_deflate.min.js")
      loadJS("io.js")
    </script>
    <script>
      "use strict"

      function submitUpload() {  // format: "[ascii type]\0[deflated binary stream]"

        var type = document.getElementById("type").value
        var buffer = new Uint8Array(type.length + 1)
        for(var i = 0; i < type.length; ++i)
          buffer[i] = type.charCodeAt(i)

        function sendRequest(buf) {
          var xhr = new XMLHttpRequest()
          onrequestJSON(xhr)
          xhr.open("post", "upload", true)
          xhr.setRequestHeader('content-type', 'application/octet-stream')
          xhr.send(buf)
          xhr.onload = function () {
            onloadJSON(this)
          }
        }

        var file = document.getElementById("input").files[0]
        if(file)
        {
          var fileReader = new FileReader()
          fileReader.readAsArrayBuffer(file)
          fileReader.onload = function () {
            var result = pako.gzip(new Uint8Array(fileReader.result), {level: 9})
            var newBuffer = new Uint8Array(buffer.byteLength + result.byteLength)
            for(var i = 0; i < buffer.byteLength; ++i)
              newBuffer[i] = buffer[i]
            for(var i = 0; i < result.byteLength; ++i)
              newBuffer[i + buffer.byteLength] = result[i]
            sendRequest(newBuffer)
          }
        }
        else
          sendRequest(buffer)

        writePage("/")

        return false

      }
    </script>
  </body>
</html>
